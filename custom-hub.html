<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/azure-styles.css">
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        VSS.require(["TFS/Dashboards/WidgetHelpers", "VSS/Service", "TFS/Build/RestClient",], async function (WidgetHelpers, VSS_Service, TFS_Build_WebApi) {
            // GET https://dev.azure.com/{organization}/{project}/_apis/pipelines?orderBy={orderBy}&$top={$top}&continuationToken={continuationToken}&api-version=7.1
            // GET https://dev.azure.com/{organization}/{project}/_apis/build/definitions?api-version=7.1
            // VSS.register("CustomHub", function () {
            const projectId = VSS.getWebContext().project.id;
            console.log("Project ID:", projectId);

            const organizationName = VSS.getWebContext().account.name;
            console.log("Organization Name:", organizationName);
            console.log("VSS_Service:", VSS_Service);
            console.log("TFS_Build_WebApi:", TFS_Build_WebApi);

            let buildClient = VSS_Service.getCollectionClient(TFS_Build_WebApi.BuildHttpClient2_2);

            const pipelineData = [
                {
                    name: "springboot-actuator-sample",
                    id: "#20250810.1",
                    description: "Set up CI with Azure Pipelines",
                    status: "error"
                },
                {
                    name: "webapp-deployment",
                    id: "#20250809.3",
                    description: "Deploy web application to Azure",
                    status: "success"
                },
                {
                    name: "api-tests",
                    id: "#20250808.2",
                    description: "Run automated API tests",
                    status: "running"
                },
                {
                    name: "database-migration",
                    id: "#20250807.1",
                    description: "Update database schema",
                    status: "success"
                }
            ];

            // Function to create a pipeline item element
            function createPipelineItem(pipeline) {

                let pipelineStatus = 0;
                let definition = {};

                // use _links to get the URL for the pipeline and badge
                const pipelineURL = pipeline._links.web.href;
                const pipelineItem = document.createElement('div');
                // if (definitions[i].id === pipeline.definition.id) {
                // definition = definitions[i];
                // console.log("Definition found:", definition);
                pipelineStatus = pipeline.queueStatus;

                // Create status icon based on pipeline status
                // let statusIcon = '';
                // let statusClass = '';

                // switch (pipeline.status) {
                //     case 2:
                //         statusIcon = 'x';
                //         statusClass = 'error-circle';
                //         break;
                //     case 1:
                //         statusIcon = '✓';
                //         statusClass = 'success-circle';
                //         break;
                //     case 'running':
                //         statusIcon = '⟳';
                //         statusClass = 'running-circle';
                //         break;
                //     default:
                //         statusIcon = '?';
                //         statusClass = 'unknown-circle';
                // }

                let definitionStatusText = '';
                let definitionStatusClass = '';
                console.log("pipelineStatus3:", pipelineStatus);
                switch (pipelineStatus) {
                    case 0:
                        definitionStatusText = '';
                        break;
                    case 1:
                        definitionStatusText = 'PAUSED';
                        definitionStatusClass = 'pipeline-paused';
                        break;
                    case 2:
                        definitionStatusText = 'DISABLED';
                        definitionStatusClass = 'pipeline-disabled';
                        break;
                    default:
                        definitionStatusText = '';
                }

                pipelineItem.className = 'pipeline-item ' + definitionStatusClass;
                // <div class="${statusClass}">${statusIcon}</div>
                // <span class="pipeline-id">${pipeline.buildNumber}</span>
                pipelineItem.innerHTML = `
                            <div class="pipeline-info">
                                <div style="width:15%"><span class="pipeline-status"><b>${definitionStatusText}</b></span></div>
                                <div class="pipeline-details-container">
                                    <a href="${pipelineURL}" class="pipeline-link" target="_blank">
                                        <div class="pipeline-name">${pipeline.name}</div>
                                    </a>
                                </div>
                                <div style="min-width: 210px;">
                                    <img src="${pipeline._links.badge.href}" alt="Pipeline Badge" />
                                </div>
                            </div>`;

                return pipelineItem;
            }


            buildClient.getDefinitions(projectId).then((definitions) => {
                console.log("Definitions:", definitions);
                for (let i = 0; i < definitions.length; i++) {
                    console.log("Definition Name:", definitions[i].name);

                    const pipelineItem = createPipelineItem(definitions[i]);
                    pipelineList.appendChild(pipelineItem);
                }
            }).catch((error) => {
                console.error("Error fetching definitions:", error);
            });


            // buildClient.getBuilds(projectId).then((builds) => {
            //     console.log("Builds:", builds);
            //     for (let i = 0; i < builds.length; i++) {
            //         console.log("Build ID:", builds[i].id);
            //         console.log("Build Name:", builds[i].definition.name);
            //         console.log("definition id:", builds[i].definition.id);

            //     }

            // }).catch((error) => {
            //     console.error("Error fetching builds:", error);
            // });


            // buildClient.getDefinition(projectId, 2).then((definition) => {
            //     console.log("Definition:", definition);
            //     console.log("Definition Name:", definition.name);
            //     console.log("Definition ID:", definition.id);
            //     console.log("Definition queueStatus:", definition.queueStatus);
            //     // pipelineStatus = definition.queueStatus;
            //     // console.log("pipelineStatus1:", pipelineStatus);
            // }).catch((error) => {
            //     console.error("Error fetching definition:", error);
            // });


            VSS.notifyLoadSucceeded();
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">Pipelines</h1>
            <div class="header-actions">
                <button class="new-pipeline-btn">New pipeline</button>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-tabs">
                <button class="nav-tab">Recent</button>
                <button class="nav-tab active">All</button>
                <button class="nav-tab">Runs</button>
            </div>
            <div class="filter-section">
                <input type="text" class="filter-input" placeholder="Filter pipelines">
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">All pipelines</h2>
                <button class="new-folder-btn">New folder</button>
            </div>

            <div class="table-header">
                <div class="table-header-text" style="width: 15%;">Status</div>
                <div class="table-header-text" style="width: 100%;">Name</div>
                <div class="table-header-text" style="min-width: 210px;">Last build status</div>
            </div>

            <div class="pipeline-list" id="pipelineList"></div>
        </div>
    </div>
</body>

</html>